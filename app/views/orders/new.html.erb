<h2>Invoice</h2>

<% subtotal = @cart.cart_items.sum { |item| item.quantity * item.product.price } %>

<table>
  <thead>
    <tr>
      <th>Product</th>
      <th>Price</th>
      <th>Quantity</th>
      <th>Subtotal</th>
    </tr>
  </thead>
  <tbody>
    <% @cart.cart_items.each do |item| %>
      <tr>
        <td><%= item.product.name %></td>
        <td><%= number_to_currency(item.product.price) %></td>
        <td><%= item.quantity %></td>
        <td><%= number_to_currency(item.quantity * item.product.price) %></td>
      </tr>
    <% end %>
  </tbody>
</table>

<% if current_user.province %>
  <% pst_rate = current_user.province.pst || 0 %>
  <% gst_rate = current_user.province.gst || 0 %>
  <% hst_rate = current_user.province.hst || 0 %>

  <% pst = subtotal * pst_rate / 100 %>
  <% gst = subtotal * gst_rate / 100 %>
  <% hst = subtotal * hst_rate / 100 %>

  <% total_taxes = pst + gst + hst %>
  <% total_price_with_taxes = subtotal + total_taxes %>

  <!-- Display tax details and total price -->
  <p>PST: <%= number_to_currency(pst) %></p>
  <p>GST: <%= number_to_currency(gst) %></p>
  <p>HST: <%= number_to_currency(hst) %></p>
  <p>Total Taxes: <%= number_to_currency(total_taxes) %></p>
  <p>Total Price (including taxes): <%= number_to_currency(total_price_with_taxes) %></p>
<% else %>
<p>Please provide your province for tax calculation.</p>
<%= form_for current_user, url: update_province_user_path(current_user), method: :put do |f| %>
  <%= f.collection_select :province_id, Province.all, :id, :name, include_blank: 'Select Province' %>
  <%= f.submit "Set Province" %>
<% end %>
<% end %>

